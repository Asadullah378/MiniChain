version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: minichain-api
    environment:
      - NODE_HOSTNAME=${NODE_HOSTNAME:-svm-11.cs.helsinki.fi}
      - API_PORT=${API_PORT:-8080}
      - CLEAN=${CLEAN:-false}
    ports:
      - "8080:8080"
    # Persist data directory
    volumes:
      - ./data:/app/data
      - ./peers.txt:/app/peers.txt:ro
      - ./config.yaml:/app/config.yaml:ro

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Point frontend at API; override in env or compose
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8080}
    container_name: minichain-frontend
    depends_on:
      - api
    ports:
      - "5173:80"

  # Optional reverse proxy (single public port)
  # Uncomment to serve both frontend and API via one nginx gateway on 80/443
  # proxy:
  #   image: nginx:alpine
  #   container_name: minichain-proxy
  #   volumes:
  #     - ./deploy/nginx-gateway.conf:/etc/nginx/conf.d/default.conf:ro
  #   depends_on:
  #     - api
  #     - frontend
  #   ports:
  #     - "80:80"
  #     # For TLS, mount certs and expose 443
  #     # - "443:443"
