version: "3.9"

services:
  # Backend Node 1
  node1:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: minichain-node1
    hostname: svm-11.cs.helsinki.fi
    environment:
      - NODE_HOSTNAME=svm-11.cs.helsinki.fi
      - API_PORT=8000
      - CLEAN=${CLEAN:-false}
    ports:
      - "8000:8000"
    volumes:
      - node1-data:/app/data
      - ./peers.txt:/app/peers.txt:ro
      - ./config.yaml:/app/config.yaml:ro
    networks:
      minichain-network:
        aliases:
          - svm-11.cs.helsinki.fi

  # Backend Node 2
  node2:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: minichain-node2
    hostname: svm-11-2.cs.helsinki.fi
    environment:
      - NODE_HOSTNAME=svm-11-2.cs.helsinki.fi
      - API_PORT=8000
      - CLEAN=${CLEAN:-false}
    ports:
      - "8001:8000"
    volumes:
      - node2-data:/app/data
      - ./peers.txt:/app/peers.txt:ro
      - ./config.yaml:/app/config.yaml:ro
    networks:
      minichain-network:
        aliases:
          - svm-11-2.cs.helsinki.fi

  # Backend Node 3
  node3:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: minichain-node3
    hostname: svm-11-3.cs.helsinki.fi
    environment:
      - NODE_HOSTNAME=svm-11-3.cs.helsinki.fi
      - API_PORT=8000
      - CLEAN=${CLEAN:-false}
    ports:
      - "8002:8000"
    volumes:
      - node3-data:/app/data
      - ./peers.txt:/app/peers.txt:ro
      - ./config.yaml:/app/config.yaml:ro
    networks:
      minichain-network:
        aliases:
          - svm-11-3.cs.helsinki.fi

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Point frontend at first node's API
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
    container_name: minichain-frontend
    depends_on:
      - node1
      - node2
      - node3
    ports:
      - "5173:80"
    networks:
      - minichain-network

volumes:
  node1-data:
  node2-data:
  node3-data:

networks:
  minichain-network:
    driver: bridge
